name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Run unit tests
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        run: |
          set +e
          xcodebuild test \
            -scheme SwiftEchada \
            -destination 'platform=macOS' \
            -skip-testing:SwiftEchadaIntegrationTests \
            2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          if grep -q "TEST SUCCEEDED" test-output.log; then
            echo "All tests passed"
            exit 0
          elif grep -q "with [1-9][0-9]* failure" test-output.log; then
            echo "Tests failed"
            exit 1
          else
            exit $TEST_EXIT_CODE
          fi

      - name: Extract test summary
        if: always()
        run: |
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output.log ]; then
            LAST_EXECUTION_LINE=$(grep "Executed.*test" test-output.log | tail -n 1)

            if [ -n "$LAST_EXECUTION_LINE" ]; then
              TOTAL_TESTS=$(echo "$LAST_EXECUTION_LINE" | grep -o "Executed [0-9]*" | grep -o "[0-9]*")
              FAILURES=$(echo "$LAST_EXECUTION_LINE" | grep -o "with [0-9]* failure" | grep -o "[0-9]*")

              if [ -z "$FAILURES" ]; then
                FAILURES=0
              fi

              PASSED=$((TOTAL_TESTS - FAILURES))

              if [ "$FAILURES" -eq 0 ]; then
                echo "✅ **All tests passed:** $TOTAL_TESTS/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              else
                echo "❌ **Failed:** $FAILURES/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "✅ **Passed:** $PASSED/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "Tests completed. Check job logs for detailed results." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No test output found" >> $GITHUB_STEP_SUMMARY
          fi


      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-output.log
          retention-days: 30

  integration-tests:
    name: Integration Tests
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Run integration tests
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        run: |
          set +e
          xcodebuild test \
            -scheme SwiftEchada \
            -destination 'platform=macOS' \
            -only-testing:SwiftEchadaIntegrationTests \
            2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          if grep -q "TEST SUCCEEDED" test-output.log; then
            echo "All tests passed"
            exit 0
          elif grep -q "with [1-9][0-9]* failure" test-output.log; then
            echo "Tests failed"
            exit 1
          else
            exit $TEST_EXIT_CODE
          fi

      - name: Extract test summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output.log ]; then
            LAST_EXECUTION_LINE=$(grep "Executed.*test" test-output.log | tail -n 1)

            if [ -n "$LAST_EXECUTION_LINE" ]; then
              TOTAL_TESTS=$(echo "$LAST_EXECUTION_LINE" | grep -o "Executed [0-9]*" | grep -o "[0-9]*")
              FAILURES=$(echo "$LAST_EXECUTION_LINE" | grep -o "with [0-9]* failure" | grep -o "[0-9]*")

              if [ -z "$FAILURES" ]; then
                FAILURES=0
              fi

              PASSED=$((TOTAL_TESTS - FAILURES))

              if [ "$FAILURES" -eq 0 ]; then
                echo "✅ **All tests passed:** $TOTAL_TESTS/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              else
                echo "❌ **Failed:** $FAILURES/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "✅ **Passed:** $PASSED/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "Tests completed. Check job logs for detailed results." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No test output found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test-output.log
          retention-days: 30
